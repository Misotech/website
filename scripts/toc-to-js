#!/usr/bin/env node

const yaml = require('js-yaml');
const fs = require('fs');
const path = require('path')
var mkdirp = require('mkdirp');

const baseDir = path.join(__dirname, '..');
const dataDir = path.join(baseDir, 'data')

const setEnabled = (items, level = 1) => {
  let hasActiveItems = false;
  let hrefs = [];

  for (const item of items) {
    item.level = level;
    let hasActiveChild = false;
    let fileExists = false;


    if (item.items) {
      const childData = setEnabled(item.items, level + 1);
      if (childData.hasActiveItems) {
        hasActiveChild = true;
      }
      if (item.level >= 2) {
        item.hrefs = [...childData.hrefs]
      }

    }

    if (item.href) {
      hrefs.push(item.href)
      const fpath = path.join(baseDir, 'pages', item.href + '.mdx');
      const fdir = path.dirname(fpath)
      if (!fs.existsSync(fdir)) {
        mkdirp.sync(fdir)
      }
      fileExists = fs.existsSync(fpath);
    }

    if (fileExists || hasActiveChild) {
      Object.assign(item, { enabled: true });
      hasActiveItems = true;
    }

  }
  return {
    hasActiveItems, hrefs
  }
}
const data = yaml.load(fs.readFileSync(path.join(dataDir, 'docs.yml')));
setEnabled(data)
fs.writeFileSync(path.join(dataDir, 'docs.js'), `/**\n * Generated by toc-to-js script\n */\nexport default ${JSON.stringify(data, undefined, 2)}`)
