# Обработка сессий

Все происходящие события группируются в активные периоды, называемые сессией или визитом.
Сессия начинается при появлении первого события, заканчивается по тайм-ауту.
Запуск новой сессии инициируется даже при скролле или движении мыши,
поэтому сессии посетителей, которые оставили вкладку открытой,
а спустя время вернулись и продолжили работу с сайтом,
будут начинаться с событий активности. Помимо тайм-аута,
активные сессии могут перезапускаться по причине визита того же самого посетителя,
но с другого источника.

Наложение источников:

 - **реклама, органика, соцсети:** старая сессия закрывается, новая открывается
 - **прямые, реферальные входы:** сессия не перезапускается

## Событие session

Сессия, как и все остальное в Rockstat, является самостоятельным событием, генерируемым в момент старта. В дальнейшем все другие события включают в себя сессионную информацию и являются ее распространителем.


## Типы сессий

* **Прямой вход**
* **Органика**
* **Рекламная кампания**
* **Социальные сети**
* **Реферальная ссылка**
* **Внутренняя сессия**

## Рекламная кампании

Сессия будет рекламной, если в параметрах есть хоть одна из этих меток: `utm_*`, `yclid`, `gclid`, `openstat`.
В некоторых случаях визит может быть классифицирован как рекламный, на основе referrer, например, c `doubleclick.net`



```json
{
  "name": "session",
  "session_engine": "google", // Идентификатор поискового/рекламного/социального движка
  "session_pageNum": 1, // Номер просматриваемой страницы
  "session_eventNum": 0, // Номер события (пока еще не было)
  "session_hasMarks": 1, // Флаг наличия рекламных меток (на уровне бд, удобнее его иметь)
  "session_marks": {
    "has_gclid": "1", // Наличие gclid
    "utm_campaign": "feb_camp",
    "utm_content": "ad_1",
    "utm_medium": "cpc",
    "utm_source": "google"
  },
  "session_num": 22, // Номер визита
  "session_refHost": "https://google.com", // Хост из referer
  "session_start": "1518849857238", // timestamp начала сессии (это время)
  "session_type": "campaign", // Классифицированый вид трафика
  //...
}
```


## Органика

Если источник - домены Google, не реклама и не g+, значит это поисковая система, т.е. органика


```json
{
  "name": "session",
  "session_engine": "google",
  "session_eventNum": 0,
  "session_hasMarks": 0,
  "session_marks": {},
  "session_num": 2,
  "session_pageNum": 1,
  "session_refHost": "google.ru",
  "session_start": "1518857893459",
  "session_type": "organic",
  //...общие поля
}
```

## Соцсети

Если источник - социальная сеть и нет рекламных меток, значит трафик социальный

```json
{
  "name": "session",
  "session_engine": "vk",
  "session_eventNum": 0,
  "session_hasMarks": 0,
  "session_marks": {},
  "session_num": 4,
  "session_pageNum": 1,
  "session_refHost": "away.vk.com",
  "session_start": "1518856888877",
  "session_type": "social"
  //...общие поля
}
```

## Реферальная ссылка

Все остальные источники, где фигурируют другие сайты

```json
{
  "name": "session",
  "session_engine": "",
  "session_eventNum": 1,
  "session_hasMarks": 0,
  "session_marks": {},
  "session_num": 3,
  "session_pageNum": 0,
  "session_refHost": "2gis.ru",
  "session_start": "1518743841188",
  "session_type": "referral"
  //...общие поля
}
```
## Остальные источники

**Внутренние сессии** ( `internal` ) - это когда сессия инициируется на самом сайте (посетитель продолжил просмотр спустя значительное время).
**Прямые входы** ( `direct` ) обычно подразумевают вход через самостоятельный ввод адреса. Но по логике, никто ничего не запоминает, а это ссылки их месседжеров и других программ, за границей браузера.

## Подсчет суммы по каналам

На основе подробной информации о каждой сессии можно с легкостью посчитать итоговую статистику по каналам и даже сделать из нее realtime дашборд при помощи [Grafana](grafana).

![](_media/alcojs_sessions/sum_by_channel.png)

## Отличия от Google Analytics

В отличие от GA, в Rockstat есть внутренние сессии.
Пример: посетитель пришел на сайт, но потом его кто-то отвлек от компьютера, и он отошел,
за это время сессия завершилась по тайм-ауту, затем он вернулся и продолжил с того места,
где остановился. В этой ситуации GA засчитает еще один визит с канала как предыдущий.
YM также имеет внутренние сессии.
