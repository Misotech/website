{"data":"<h1 id=\"grafana\">Grafana</h1>\n<blockquote>\n<p><strong>Доступ в Grafana</strong> по адресу <a href=\"http://172.16.25.1:3000\">http://172.16.25.1:3000</a> после <a href=\"connect-vpn\">подключения к VPN</a>. Данные для входа <strong>admin</strong>/<strong>admin</strong></p>\n</blockquote>\n<p>#№ Добавление ClickHouse data source в Grafana</p>\n<p>Сводится к добавлению нового источника данных</p>\n<p><img src=\"/static/media/data_tools_grafana/add_data_source.png\" alt=\"\"></p>\n<p><strong>Параметры подключения</strong></p>\n<p>Name: AlcolyticsDB\nType: ClickHouse\nURL: <a href=\"http://172.16.25.1:8123\">http://172.16.25.1:8123</a>\nAccess: proxy\nBasic Auth: да\nLogin/Password: alco\nAdd CORS flag to requests: да</p>\n<p><img src=\"/static/media/data_tools_grafana/data_source_settings.png\" alt=\"\"></p>\n<p>После нажатия &quot;Save &amp; Test&quot; вы должны увидеть сообщение об успешной проверке и добавлении нового источника данных</p>\n<p><img src=\"/static/media/data_tools_grafana/add_source_success.png\" alt=\"\"></p>\n<h2 id=\"-dashboard\">Создание Dashboard</h2>\n<p>Переходим в раздел дашбордов</p>\n<p><img src=\"/static/media/data_tools_grafana/dashboards.png\" alt=\"\"></p>\n<p>Следуя предлагаемым действиям переходим к созданию своего первого дашборда</p>\n<p><img src=\"/static/media/data_tools_grafana/create_dashboard.png\" alt=\"\"></p>\n<h2 id=\"-graph-\">Первый Graph виджет</h2>\n<p>В качестве тренировки создадим виджет, который разложит сессии по типу девайса: десктом/мобильный/etc. В интерфейсе конфигурации дашборда выбираем виджет Graph</p>\n<p><img src=\"/static/media/data_tools_grafana/create_graph_widget.png\" alt=\"\"></p>\n<p>Попадаем в превью виджета, из которого можем перейти в его настройки</p>\n<p><img src=\"/static/media/data_tools_grafana/widget_setup.png\" alt=\"\"></p>\n<p>Установите базу данных <strong>alco</strong> и таблицу <strong>events</strong> , затем перейдите к созданию запроса</p>\n<p><img src=\"/static/media/data_tools_grafana/create_request.png\" alt=\"\"></p>\n<p>Первым делом в разделе &quot;Metrics&quot; укажем шаг сглаживания данных 5m (5 минут), этого вполне достаточно. Но при наличии достаточного объема данных, можете поиграться, изменяя в большую или меньшую сторону. Указываем запрос:</p>\n<pre><code class=\"language-sql\">$columns(device_type, count() amount) FROM $table WHERE name = &#39;session&#39;</code></pre>\n<p>Тут мы используем готовый макрос для построения запросов $columns и отбираем только события типа session</p>\n<p><img src=\"/static/media/data_tools_grafana/filter_session.png\" alt=\"\"></p>\n<p>Переходим на вкладку General. В Title пишем &quot;Device types&quot;</p>\n<p><img src=\"/static/media/data_tools_grafana/device_types.png\" alt=\"\"></p>\n<p>Переходим на вкладку Display и устанавливаем Null value = null as zero, затем выходим из режима управления виджетом</p>\n<p><img src=\"/static/media/data_tools_grafana/null_value.png\" alt=\"\"></p>\n<p>Теперь можно сохранить дашборд нажатием CMD (CTRL) + S или кликнув на соответствующую иконку</p>\n<p><img src=\"/static/media/data_tools_grafana/save_dashboard.png\" alt=\"\"></p>\n<h2 id=\"-pie-chart\">Создание Pie Chart</h2>\n<p>Наведите курсор в самую левую часть строки, откроется менюха, где выбираем Add Panel, затем Pie Chart.</p>\n<p><img src=\"/static/media/data_tools_grafana/add_panel.png\" alt=\"\"></p>\n<p>Как и в предыдущем примере, переходим в интерфейс настроек виджета, первым делом указываем источник данных: база alco, таблица events, переходим к запросу.</p>\n<pre><code class=\"language-sql\">SELECT\n  1,\n  groupArray((type, Events))\nFROM (\n  SELECT\n    if(session_num = 1, &#39;New&#39;, &#39;Returning&#39;) as type,\n    count() AS Events\n  FROM $table\n  WHERE\n    $timeFilter\n    AND name = &#39;session&#39;\n  GROUP BY type\n  ORDER BY Events desc\n)</code></pre>\n<p>Ставим Step = 1h (один час). Вот, что должно получиться:</p>\n<p><img src=\"/static/media/data_tools_grafana/set_step.png\" alt=\"\"></p>\n<p>Устанавливаем имя, выходим из режима редактирования. Вот что получаем в итоге:</p>\n<p><img src=\"/static/media/data_tools_grafana/pie_chart_screenshot.png\" alt=\"\"></p>\n<p>Не забываем сохраниться</p>\n<h2 id=\"-\">Базовый дашборд</h2>\n<p>Имеется конфигурация простенького дашборда, которую вы можете загрузить себе.\nИмпорт находится в меню поиска дашборда, <a href=\"/media/grafana_base_dash.json\" title=\":ignore\">файл конфигурации</a>.</p>\n<p><img src=\"/static/media/data_tools_grafana/home_button.png\" alt=\"\"></p>\n<h2 id=\"-\">Полезные ссылки</h2>\n<ul>\n<li>Сайт Grafana с кучей примеров <a href=\"https://grafana.com\">https://grafana.com</a></li>\n<li>Дока Grafana <a href=\"http://docs.grafana.org/guides/basic_concepts\">http://docs.grafana.org/guides/basic_concepts</a></li>\n<li>Дока по использованию ClickHouse в Grafana <a href=\"https://grafana.com/plugins/vertamedia-clickhouse-datasource\">https://grafana.com/plugins/vertamedia-clickhouse-datasource</a></li>\n</ul>\n"}