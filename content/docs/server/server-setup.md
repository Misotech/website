# Установка и обновление платформы


### Минимальная конфигурация

Большинству проектов хватит небольшого виртуального сервера

- **CPU**: 2 core (лучше 4)
- **Память**: 8 gb
- **Диск**: 50 gb, обязательно SSD, будет увеличиваться по необходимости
- **ОС**: строго Ubuntu Server 16.04

Данной конфигурации будет достаточно для обслуживания нескольких сайтов суммарным объемом визитов 3-4м.
Если отключить трекер активности, можно обслуживать порядка 10м - 20м визитов в месяц

?> **Домен для Rockstat**
 После того, как сервер готов и запущен,
 вам нужно настроить трекинговый домен, на котором будет работать система сбора данных. Обычно это alco.ваш-домен.ru, но можете использовать любой другой. Как именно это сделать, сильно зависит от регистратора домена. Основной смысл: создать А запись, указывающую на IP адрес сервера.


### Подключение к серверу

Откройте терминал и подключитесь к серверу по имени домена, к которому привязали сервер, чтобы убедиться в его работоспособности.

```bash
ssh root@alco.pornhub.com
```

Вместо `root`, у вас может быть другой пользователь


?> **Подключение к серверу в Windows.** В комплекте Windows нет ssh клиента,
    но можно воспользоваться программой [putty](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html)

### Запуск скриптика, который сам все сделает

После успешного проникновения на объект следует выполнить:

на всякий случай проверим, что curl установлен (нужен для загрузки файлов из интернета, бывает, что не включается в минимальную поставку ubuntu)

```bash
sudo apt -y update && sudo apt -y install curl
```

Теперь запускаем скрипт установки/обновления системы

```bash
bash <(curl -Ss https://raw.githubusercontent.com/alcolytics/alco-bootstrap/master/bin/from-scratch)
```

Несколько секунд и все готово! После этого скрипт предложит создать файл инвентаря с
осноными параметрами будущего счетчика. Рекомендую соглашаться.

<img src="/media/casts/prepare3.svg" class="asciicast" />

Первый скрипт загрузил ansible playbook, который произведет процесс полной установки

```bash
ansible-playbook alcolytics.yml --connection=local
```

<img src="/media/casts/setup1.svg" class="asciicast" />

### Если что-то пошло не так

Подготовка сервера без использования скипта. Установите минимальные необходимые
зависимости и произведите преднастройку системы, последовательно выполнив все команды.

```bash
sudo -i

apt -y update

apt install -y python-minimal python-pip python-netaddr git locales

echo -e 'LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8' | sudo tee /etc/default/locale
locale-gen en_US.UTF-8
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

pip install ansible

exit

git clone https://github.com/alcolytics/alco-bootstrap
git submodules init

cd ~/alco-bootstrap
```

Теперь надо создать файл inventory/private вот с таким содержимым:

```
[private]
alcostat ansible_host=alco.yourdomain.com

[private:vars]
tracker_domain=alco.yourdomain.com
contact_email=youemail@example.com
```

Для это можно использовать редактор `nano` или какой-либо другой

```
nano inventory/private
```


После этого можно запускать процесс установки

```bash
ansible-playbook alcolytics.yml --connection=local
```

!> **Нигде нет информации, как достать с установленного сервера vpn ключи** И,
    правда, нет! Изначально план установки был другой, и все рассылалось по почте.
    Теперь надо воспользоваться scp, если у вас Mac или Linux. `scp root@stat.textapp.me:/srv/alco/ovpn_keys/alco_user1.ovpn .`
    Если Windows, надо поискать программку вроде winscp, подключиться и скопировать.
    Ключи тут: `/srv/alco/ovpn_keys`


### Секретики в установщике

По дефолту предусмотрена функция удаленного обновления, для этого в проекте имеется
специальный ключ `public_keys/alco.pub`, при помощи которого сервер обновлений может подключатся к серверу Rockstat
для выполнения необходимых операций. Если нет желания иметь что-то общее с сервером обновлений,
просто удалите этот файлик.

### Автоматическое централизованное обновление

Имеется централизованная система автоматического обновления всех серверов Rockstat.  Для подключения достаточно найти в чате Dmitry Rodin (меня) и попросить
добавить сервер в список доставки обновлений.



### Кастомизация конфигурации

Файлы, чьи имена начинаются с `priv`, расположенные `inventoty/`, `group_vars` и `host_vars` исключены из git

#### Конфигурация установшика

Полный список параметров можно найти в дефолтах ролей в `roles/*/defaults/*`
Не изменяйте основной файл `group_vars/all`, создайте отдельный файл, совпадающий с названием группы хостов.
Пример: делаете копию `inventory/all` под названием `inventory/private`, создаете файл конфигурации `group_vars/private`,
все указанные настройки перезапишут аналоги из `all`.
